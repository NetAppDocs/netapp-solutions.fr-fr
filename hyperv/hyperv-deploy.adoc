---
sidebar: sidebar 
permalink: hyperv/hyperv-deploy.html 
keywords: hyperv, hyper-v, deploy, netapp, virtualization 
summary: 'La solution fournit les étapes nécessaires au déploiement d"Hyper-V sur un stockage NetApp' 
---
= Déploiement de Microsoft Hyper-V sur un système de stockage NetApp
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/


[role="lead"]
La plate-forme Windows Server utilise le rôle Hyper-V pour fournir une technologie de virtualisation. Hyper-V est l'un des nombreux rôles facultatifs qui sont proposés avec Windows Server.



== Présentation

Le rôle Hyper-V nous permet de créer et de gérer un environnement informatique virtualisé à l'aide de la technologie de virtualisation intégrée à Windows Server. La technologie Hyper-V virtualise le matériel pour fournir un environnement dans lequel vous pouvez exécuter plusieurs systèmes d'exploitation simultanément sur un seul ordinateur physique. Hyper-V vous permet de créer et de gérer des machines virtuelles et leurs ressources. Chaque machine virtuelle est un système informatique isolé et virtualisé qui peut exécuter son propre système d'exploitation. Hyper-V fournit une infrastructure permettant de virtualiser les applications et les charges de travail qui prennent en charge divers objectifs commerciaux visant à améliorer l'efficacité et à réduire les coûts, ce qui constitue une alternative parfaite à VMware® vSphere, en particulier lorsque les entreprises recherchent la coexistence de plusieurs hyperviseurs dans les conditions actuelles du marché.



== Public

Ce document décrit les procédures d'architecture et de déploiement de la configuration de cluster Hyper-V avec les systèmes NetApp ONTAP. Ce document est destiné aux ingénieurs commerciaux, aux consultants de terrain, aux services professionnels, aux responsables INFORMATIQUES, aux ingénieurs partenaires, et aux clients qui souhaitent déployer Hyper-V en tant qu'hyperviseur principal ou secondaire.



== Architecture

L'architecture décrite dans ce document inclut spécifiquement la virtualisation Microsoft® Windows Server® 2022 et Hyper-V®. Dans le cadre de chaque déploiement, NetApp recommande vivement le logiciel de virtualisation et le logiciel de gestion de l'infrastructure. La configuration utilise les meilleures pratiques pour chaque composant afin de mettre en place une infrastructure fiable de niveau entreprise.



== Récapitulatif des cas d'utilisation

Ce document décrit les procédures de déploiement et les meilleures pratiques à suivre pour configurer un cluster Hyper-V de manière optimale en tant que charge de travail sur Microsoft Windows Server 2022 à l'aide des modèles de baies FAS et ASA 100 % Flash de NetApp. Le système d'exploitation/hyperviseur du serveur est Microsoft Windows Server 2022. Les recommandations portent sur les systèmes de stockage NetApp qui fournissent des données via les protocoles SAN et NAS.



== Procédure de déploiement

Cette rubrique explique comment configurer et déployer un cluster de basculement à deux nœuds et des machines virtuelles Hyper-V en cluster exploitant le système de stockage ONTAP.



=== Conditions préalables à la procédure de déploiement

* Tout le matériel doit être certifié pour la version de Windows Server que vous exécutez et la solution complète de cluster de basculement doit réussir tous les tests de l'Assistant validation d'une configuration
* Les nœuds Hyper-V se sont joints au contrôleur de domaine (recommandé) et une connectivité appropriée entre eux.
* Chaque nœud Hyper-V doit être configuré de manière identique.
* Adaptateurs réseau et switchs virtuels désignés configurés sur chaque serveur Hyper-V pour un trafic séparé pour la gestion, ISCSI, SMB et la migration en direct.
* La fonctionnalité cluster de basculement est activée sur chaque serveur Hyper-V.
* Les partages SMB ou les CSV sont utilisés comme stockage partagé pour stocker les machines virtuelles et leurs disques pour la mise en cluster Hyper-V.
* Le stockage ne doit pas être partagé entre des clusters différents. Prévoyez un ou plusieurs partages CSV/CIFS par cluster.
* Si le partage SMB est utilisé comme stockage partagé, les autorisations sur le partage SMB doivent être configurées de manière à accorder l'accès aux comptes ordinateur de tous les nœuds Hyper-V du cluster.


Pour plus d'informations, voir :

* link:https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/system-requirements-for-hyper-v-on-windows#how-to-check-for-hyper-v-requirements["Configuration système requise pour Hyper-V sur Windows Server"]
* link:https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj134244(v=ws.11)#step-1-prepare-to-validate-hardware-for-a-failover-cluster["Validation du matériel pour un cluster de basculement"]
* link:https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj863389(v=ws.11)["Déployer un cluster Hyper-V."]


.Installation des fonctionnalités Windows
[%collapsible]
====
Les étapes suivantes décrivent comment installer les fonctionnalités requises de Windows Server 2022.

*Tous les hôtes*

. Préparez le système d'exploitation Windows 2022 avec les mises à jour et les pilotes de périphériques nécessaires sur tous les nœuds désignés.
. Connectez-vous à chaque nœud Hyper-V à l'aide du mot de passe administrateur saisi lors de l'installation.
. Lancez une invite PowerShell en cliquant avec le bouton droit de la souris sur l'icône PowerShell dans la barre des tâches et en sélectionnant `Run as Administrator`.
. Ajoutez les fonctionnalités Hyper-V, MPIO et de mise en cluster.
+
[source, cli]
----
Add-WindowsFeature Hyper-V, Failover-Clustering, Multipath-IO `-IncludeManagementTools –Restart
----


====
.Configuration des réseaux
[%collapsible]
====
Une bonne planification du réseau est essentielle pour obtenir un déploiement tolérant aux pannes. La configuration de cartes réseau physiques distinctes pour chaque type de trafic a été la suggestion standard pour un cluster de basculement. Grâce à la possibilité d'ajouter des cartes réseau virtuelles, de mettre en place un ENSEMBLE (agrégation) intégré de commutateurs et des fonctionnalités telles que Hyper-V QoS, condensez le trafic réseau sur un nombre réduit de cartes physiques. Concevez la configuration réseau en tenant compte de la qualité de service, de la redondance et de l'isolation du trafic. La configuration de techniques d'isolation du réseau comme les VLAN et des techniques d'isolation du trafic assure la redondance du trafic et de la qualité du service, ce qui améliorerait et améliorerait la cohérence des performances du trafic de stockage.

Il est conseillé de séparer et d'isoler des charges de travail spécifiques à l'aide de plusieurs réseaux physiques et/ou logiques. Voici des exemples de trafic réseau généralement divisés en segments :

* Réseau de stockage ISCSI.
* CSV (Cluster Shared Volume) ou réseau Heartbeat.
* Migration en direct
* Réseau de machines virtuelles
* Réseau de gestion



NOTE: Lorsque iSCSI est utilisé avec des cartes réseau dédiées, l'utilisation d'une solution de regroupement n'est pas recommandée et MPIO/DSM doit être utilisé.


NOTE: Les meilleures pratiques en matière de mise en réseau Hyper-V déconseillent également l'utilisation du regroupement de cartes réseau pour les réseaux de stockage SMB 3.0 dans un environnement Hyper-V.

Pour plus d'informations, reportez-vous à la section link:https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/plan/plan-hyper-v-networking-in-windows-server["Planifiez la mise en réseau Hyper-V dans Windows Server"]

====
.Décider de la conception du stockage pour Hyper-V.
[%collapsible]
====
Hyper-V prend en charge NAS (SMB3.0) et le stockage bloc (iSCSI/FC) comme stockage secondaire pour les machines virtuelles. NetApp prend en charge le protocole SMB3.0, iSCSI et FC qui peut être utilisé comme stockage natif pour les VM - volumes CSV (Cluster Shared volumes) avec iSCSI/FC et SMB3. Les clients peuvent également utiliser SMB3 et iSCSI comme options de stockage invité pour les charges de travail qui nécessitent un accès direct au stockage. ONTAP propose des options flexibles avec un stockage unifié (baie 100 % Flash) pour les charges de travail qui nécessitent un accès à des protocoles mixtes et un stockage optimisé pour le SAN (baie 100 % SAN) pour les configurations SAN uniquement.

La décision d'utiliser SMB3 plutôt que iSCSI/FC dépend de l'infrastructure existante actuellement en place. SMB3/iSCSI permet aux clients d'utiliser l'infrastructure réseau existante. Pour les clients qui disposent d'une infrastructure FC existante peuvent exploiter cette infrastructure et la présenter sous forme de volumes partagés en cluster basés sur FC.

*Remarque :* Un contrôleur de stockage NetApp exécutant le logiciel ONTAP peut prendre en charge les charges de travail suivantes dans un environnement Hyper-V :

* Machines virtuelles hébergées dans des partages SMB 3.0 disponibles en continu
* Serveurs virtuels hébergés sur des LUN CSV (Cluster Shared Volume) s'exécutant sur iSCSI ou FC
* Stockage In-Guest et disques de transfert vers les machines virtuelles invitées



NOTE: Des fonctionnalités ONTAP essentielles, telles que l'allocation dynamique, la déduplication, la compression, la compaction des données, les clones flexibles, les copies Snapshot et la réplication fonctionnent en arrière-plan de manière transparente, indépendamment de la plateforme ou du système d'exploitation, ce qui apporte une valeur ajoutée considérable aux charges de travail Hyper-V. Les paramètres par défaut de ces fonctionnalités sont optimaux pour Windows Server et Hyper-V.


NOTE: MPIO est pris en charge sur la machine virtuelle invitée à l'aide d'initiateurs invités si plusieurs chemins d'accès sont disponibles pour la machine virtuelle, et si la fonctionnalité de chemins d'accès E/S multiples est installée et configurée.


NOTE: ONTAP prend en charge tous les principaux protocoles client standard de l'industrie : NFS, SMB, FC, FCoE, iSCSI, NVMe/FC et S3. Cependant, NVMe/FC et NVMe/TCP ne sont pas pris en charge par Microsoft.

====
.Installation des utilitaires hôtes iSCSI Windows de NetApp
[%collapsible]
====
La section suivante décrit comment effectuer une installation automatique des utilitaires d'hôtes iSCSI Windows de NetApp. Pour plus d'informations sur l'installation, reportez-vous au link:https://docs.netapp.com/us-en/ontap-sanhost/hu_wuhu_72.html["Installer Windows Unified Host Utilities 7.2 (ou la dernière version prise en charge)"]

*Tous les hôtes*

. Télécharger link:https://mysupport.netapp.com/site/products/all/details/hostutilities/downloads-tab/download/61343/7.2["Utilitaires d'hôtes iSCSI Windows"]
. Débloquer le fichier téléchargé.
+
[source, cli]
----
Unblock-file ~\Downloads\netapp_windows_host_utilities_7.2_x64.msi
----
. Installez les utilitaires hôtes.
+
[source, cli]
----
~\Downloads\netapp_windows_host_utilities_7.2_x64.msi /qn "MULTIPATHING=1"
----



NOTE: Le système redémarre pendant ce processus.

====
.Configuration de l'initiateur iSCSI de l'hôte Windows
[%collapsible]
====
Les étapes suivantes décrivent comment configurer l'initiateur iSCSI Microsoft intégré.

*Tous les hôtes*

. Lancez une invite PowerShell en cliquant avec le bouton droit de la souris sur l'icône PowerShell dans la barre des tâches et en sélectionnant Exécuter en tant qu'administrateur.
. Configurez le service iSCSI pour qu'il démarre automatiquement.
+
[source, cli]
----
Set-Service -Name MSiSCSI -StartupType Automatic
----
. Démarrez le service iSCSI.
+
[source, cli]
----
Start-Service -Name MSiSCSI
----
. Configurez MPIO pour réclamer tout périphérique iSCSI.
+
[source, cli]
----
Enable-MSDSMAutomaticClaim -BusType iSCSI
----
. Définissez la règle d'équilibrage de charge par défaut de tous les périphériques nouvellement réclamés sur round Robin.
+
[source, cli]
----
Set-MSDSMGlobalDefaultLoadBalancePolicy -Policy RR 
----
. Configurez une cible iSCSI pour chaque contrôleur.
+
[source, cli]
----
New-IscsiTargetPortal -TargetPortalAddress <<iscsia_lif01_ip>> -InitiatorPortalAddress <iscsia_ipaddress>

New-IscsiTargetPortal -TargetPortalAddress <<iscsib_lif01_ip>> -InitiatorPortalAddress <iscsib_ipaddress

New-IscsiTargetPortal -TargetPortalAddress <<iscsia_lif02_ip>> -InitiatorPortalAddress <iscsia_ipaddress>

New-IscsiTargetPortal -TargetPortalAddress <<iscsib_lif02_ip>> -InitiatorPortalAddress <iscsib_ipaddress>
----
. Connectez une session pour chaque réseau iSCSI à chaque cible.
+
[source, cli]
----
Get-IscsiTarget | Connect-IscsiTarget -IsPersistent $true -IsMultipathEnabled $true -InitiatorPo rtalAddress <iscsia_ipaddress>

Get-IscsiTarget | Connect-IscsiTarget -IsPersistent $true -IsMultipathEnabled $true -InitiatorPo rtalAddress <iscsib_ipaddress>
----



NOTE: Ajoutez plusieurs sessions (min. De 5 à 8) pour améliorer les performances et utiliser la bande passante.

====
.Création d'un cluster
[%collapsible]
====
*Un seul serveur*

. Lancez une invite PowerShell avec des autorisations d'administration, en cliquant avec le bouton droit de la souris sur l'icône PowerShell et en sélectionnant `Run as Administrator``.
. Créez un nouveau cluster.
+
[source, cli]
----
New-Cluster -Name <cluster_name> -Node <hostnames> -NoStorage -StaticAddress <cluster_ip_address>
----
+
image:hyperv-deploy-image01.png["Image montrant l'interface de gestion du cluster"]

. Sélectionnez le réseau de cluster approprié pour la migration dynamique.
. Désigner le réseau CSV.
+
[source, cli]
----
(Get-ClusterNetwork -Name Cluster).Metric = 900
----
. Modifiez le cluster pour qu'il utilise un disque de quorum.
+
.. Lancez une invite PowerShell avec des autorisations d'administration en cliquant avec le bouton droit de la souris sur l'icône PowerShell et en sélectionnant « Exécuter en tant qu'administrateur ».
+
[source, cli]
----
start-ClusterGroup "Available Storage"| Move-ClusterGroup -Node $env:COMPUTERNAME
----
.. Dans le Gestionnaire de clusters de basculement, sélectionnez `Configure Cluster Quorum Settings`.
+
image:hyperv-deploy-image02.png["Illustration des paramètres configurer le quorum du cluster"]

.. Cliquez sur Suivant dans la page d'accueil.
.. Sélectionnez le témoin de quorum et cliquez sur Suivant.
.. Sélectionnez configurer un témoin de disque et cliquez sur Suivant.
.. Sélectionnez disque W: Dans le stockage disponible et cliquez sur Suivant.
.. Cliquez sur Suivant dans la page de confirmation et sur Terminer dans la page de résumé.
+
Pour plus d'informations sur le quorum et le témoin, voir link:https://learn.microsoft.com/en-us/windows-server/failover-clustering/manage-cluster-quorum#general-recommendations-for-quorum-configuration["Configuration et gestion du quorum"]



. Exécutez l'assistant de validation de cluster depuis le gestionnaire de clusters de basculement pour valider le déploiement.
. Créez une LUN CSV pour stocker les données de la machine virtuelle et créer des machines virtuelles hautement disponibles via les rôles dans Failover Cluster Manager.


====


== Considérations, fonctionnalités et intégrations



=== Facteurs à prendre en compte

Cette étape est essentielle pour vérifier que les applications, les services et les charges de travail peuvent fonctionner efficacement dans l'environnement Hyper-V. Les vérifications de compatibilité doivent inclure les versions du système d'exploitation, les versions du serveur Windows, les dépendances d'application, les systèmes de base de données et toutes les configurations ou personnalisations spécifiques qui existent dans l'environnement existant.

.Dimensionnez correctement le stockage
[%collapsible]
====
Avant de déployer la charge de travail ou de migrer depuis un hyperviseur existant, assurez-vous que la charge de travail est dimensionnée pour répondre aux besoins de performances. Pour ce faire, il suffit de collecter les données de performances de chaque machine virtuelle. Celles-ci collectent les statistiques relatives au CPU (utilisé/provisionné), à la mémoire (utilisée/provisionnée), au stockage (provisionné/utilisé), au débit et à la latence du réseau, ainsi que l'agrégation des IOPS de lecture/écriture, du débit et de la taille des blocs. Ces paramètres sont obligatoires pour garantir la réussite du déploiement et dimensionner correctement la baie de stockage et les hôtes de charge de travail.


NOTE: Planifiez les IOPS et la capacité lors du dimensionnement du stockage pour Hyper-V et les charges de travail associées.


NOTE: Pour les machines virtuelles à E/S plus élevées ou celles qui requièrent de nombreuses ressources et capacités, séparez le système d'exploitation et les disques de données. Le système d'exploitation et les binaires des applications changent rarement, et la cohérence des défaillances des volumes est acceptable.


NOTE: Utilisez le stockage connecté en invité pour les disques de données hautes performances par rapport aux disques durs virtuels. Cela facilite également le processus de clonage.

====
.Améliorer les performances des machines virtuelles
[%collapsible]
====
Choisissez la quantité appropriée de RAM et de vCPU pour des performances optimales et connectez plusieurs disques à un seul contrôleur SCSI virtuel. L'utilisation de VHDx fixe est toujours recommandée comme principale solution pour les disques virtuels dans le cadre de déploiements. Il n'existe aucune restriction quant à l'utilisation d'un type quelconque de disques virtuels VHDX.


NOTE: Évitez d'installer des rôles inutiles sur Windows Server qui ne seront pas utilisés.


NOTE: Choisissez Gen2 comme génération pour les machines virtuelles capables de charger des machines virtuelles depuis le contrôleur SCSI et basée sur l'architecture VMBUS et VSP/VSC pour le niveau de démarrage, ce qui augmente considérablement les performances globales des machines virtuelles.


NOTE: Évitez de créer des points de contrôle fréquents, car cela a un impact négatif sur les performances de la machine virtuelle.

====
.Conception et considération de SMB3.0
[%collapsible]
====
Les partages de fichiers SMB 3.0 peuvent être utilisés comme stockage partagé pour Hyper-V. ONTAP prend en charge la continuité de l'activité sur les partages SMB pour Hyper-V. Hyper-V peut utiliser des partages de fichiers SMB pour stocker les fichiers des machines virtuelles, tels que les fichiers de configuration, les snapshots et les fichiers des disques durs virtuels (VHD). Utiliser le SVM CIFS ONTAP dédié pour les partages basés sur SMB3.0 pour Hyper-V. Les volumes utilisés pour stocker les fichiers des machines virtuelles doivent être créés avec des volumes de type sécurité NTFS. La connectivité entre les hôtes Hyper-V et la baie NetApp est recommandée sur un réseau de 10 Go, si celui-ci est disponible. Dans le cas d'une connectivité réseau de 1 Go, NetApp recommande de créer un groupe d'interfaces composé de plusieurs ports de 1 Go. Connectez chaque carte réseau servant le multicanal SMB à son sous-réseau IP dédié de sorte que chaque sous-réseau fournit un chemin unique entre le client et le serveur.

Points clés

* Activez SMB multicanal sur le SVM ONTAP
* Les SVM ONTAP CIFS doivent avoir au moins une LIF de données sur chaque nœud d'un cluster.
* Les partages utilisés doivent être configurés avec l'ensemble de propriétés disponibles en continu.
* ONTAP One est désormais disponible sur tous les systèmes AFF (A-Series et C-Series), ASA (All-SAN Array) et FAS. Aucune licence distincte n'est donc nécessaire.
* Pour un VHDx partagé, utilisez un LUN iSCSI connecté à l'invité



NOTE: ODX est pris en charge et fonctionne quel que soit le protocole utilisé. La copie des données entre un partage de fichiers et iSCSI ou un LUN connecté au protocole FCP utilise également ODX.


NOTE: Les paramètres de temps des nœuds du cluster doivent être configurés en conséquence. Le protocole NTP (Network Time Protocol) doit être utilisé si le serveur CIFS NetApp doit participer au domaine Active Directory (AD) de Windows.


NOTE: Les valeurs MTU importantes doivent être activées via le serveur CIFS. Des paquets de petite taille peuvent entraîner une dégradation des performances.

====
.Provisionnement du volume SMB
[%collapsible]
====
. Vérifier que les options de serveur CIFS requises sont activées sur la machine virtuelle de stockage (SVM)
. Les options suivantes doivent être définies sur true : smb2-activé smb3-copie-déchargement-activé shadowcopy-activé est-multicanal-activé est-large-mtu-activé
+
image:hyperv-deploy-image03.png["Illustration des paramètres de colonnes SMB"]

. Créer des volumes de données NTFS sur la machine virtuelle de stockage (SVM), puis configurer les partages disponibles en continu pour les utiliser avec Hyper-V.
+
image:hyperv-deploy-image04.png["Illustration des paramètres du volume de données NTFS"]

+

NOTE: La continuité de l'activité pour Hyper-V sur SMB ne fonctionne pas correctement, sauf si les volumes utilisés dans la configuration sont créés en tant que volumes de sécurité NTFS.

. Activez la disponibilité continue et configurez les autorisations NTFS sur le partage pour inclure les nœuds Hyper-V avec un contrôle total.
+
image:hyperv-deploy-image05.png["Illustration des paramètres d'autorisations NTFS"]



Pour obtenir des conseils détaillés sur les meilleures pratiques, reportez-vous à la section link:https://docs.netapp.com/us-en/ontap-apps-dbs/microsoft/win_overview.html["Instructions de déploiement et meilleures pratiques pour Hyper-V."].

Pour plus d'informations, reportez-vous à la section link:https://docs.netapp.com/us-en/ontap/smb-hyper-v-sql/server-volume-requirements-hyper-v-concept.html["Exigences en termes de volumes et de serveurs SMB pour Hyper-V sur SMB
"].

====
.Conception et prise en compte du protocole bloc
[%collapsible]
====
Points clés

* Utilisez les chemins d'accès multiples (MPIO) sur les hôtes pour gérer les chemins multiples. Créez davantage de chemins en fonction des besoins, pour faciliter les opérations de mobilité des données ou pour exploiter des ressources d'E/S supplémentaires, sans toutefois dépasser le nombre maximal de chemins pris en charge par le système d'exploitation hôte.
* Installez Host Utilities Kit sur les hôtes accédant aux LUN.
* Créez un minimum de 8 volumes.



NOTE: Utilisez une LUN par volume, avec un mappage de 1:1 pour le rapport LUN/CSV.

* Un SVM doit avoir une LIF par réseau Ethernet ou une structure Fibre Channel sur chaque contrôleur de stockage qui va transmettre des données via iSCSI ou Fibre Channel.
* Les SVM qui assurent le service des données avec FCP ou iSCSI ont besoin d'une interface de gestion SVM.


====
.Provisionnement du volume ISCSI
[%collapsible]
====
Pour provisionner le volume ISCSI, assurez-vous que les conditions préalables suivantes sont remplies.

* Le protocole iSCSI doit être activé sur la machine virtuelle de stockage (SVM) et les interfaces logiques appropriées (LIF) créées.
* L'agrégat désigné doit disposer de suffisamment d'espace libre pour contenir la LUN.



NOTE: Par défaut, ONTAP utilise le mappage de LUN sélectif (SLM) pour rendre la LUN accessible uniquement via des chemins sur le nœud propriétaire de la LUN et son partenaire haute disponibilité.

* Configurer toutes les LIFs iSCSI sur chaque nœud pour la mobilité des LUN en cas de déplacement de la LUN vers un autre nœud du cluster.


*Étapes*

. Utilisez System Manager et naviguez jusqu'à la fenêtre LUN (l'interface de ligne de commandes de ONTAP peut être utilisée pour la même opération).
. Cliquez sur Créer .
. Faire Browse et sélectionner le SVM désigné dans lequel les LUN à créer et l'assistant de création de LUN est affiché.
. Sur la page Propriétés générales, sélectionnez Hyper-V pour les LUN contenant des disques durs virtuels (VHD) pour les machines virtuelles Hyper-V.
+
image:hyperv-deploy-image06.png["Illustration de la page Propriétés générales pour la création de LUN Hyper-V."]

. <cliquez sur plus d'options> sur la page Container de LUN, sélectionnez un volume FlexVol existant. Dans le cas contraire, un nouveau volume sera créé.
. <cliquez sur plus d'options> sur la page mappage des initiateurs, cliquez sur Ajouter un groupe initiateur, entrez les informations requises dans l'onglet général, puis, dans l'onglet initiateurs, entrez le nom du nœud initiateur iSCSI des hôtes.
. Confirmez les détails, puis cliquez sur Terminer pour terminer l'assistant.


Une fois la LUN créée, accédez au Gestionnaire du cluster de basculement. Pour ajouter un disque au CSV, le disque doit être ajouté au Storage Group disponible du cluster (s'il n'est pas déjà ajouté), puis ajouté au CSV sur le cluster.


NOTE: La fonctionnalité CSV est activée par défaut dans le clustering avec basculement.

*Ajout d'un disque au stockage disponible:*

. Dans le Gestionnaire de clusters de basculement, dans l'arborescence de la console, développez le nom du cluster, puis développez stockage.
. Cliquez avec le bouton droit de la souris sur disques, puis sélectionnez Ajouter un disque. Une liste s'affiche, répertoriant les disques pouvant être ajoutés pour être utilisés dans un cluster de basculement.
. Sélectionnez le ou les disques à ajouter, puis cliquez sur OK.
. Les disques sont désormais affectés au Storage Group disponible.
. Ensuite, sélectionnez le disque qui vient d'être attribué au stockage disponible, cliquez avec le bouton droit de la souris sur la sélection, puis sélectionnez Ajouter aux volumes partagés du cluster.
+
image:hyperv-deploy-image07.png["Illustration de l'interface Ajouter à l'interface volumes partagés de cluster"]

. Les disques sont désormais affectés au groupe Cluster Shared Volume du cluster. Les disques sont exposés à chaque nœud de cluster sous forme de volumes numérotés (points de montage) sous le dossier %SystemDrive%ClusterStorage. Les volumes apparaissent dans le système de fichiers CSVFS.


Pour plus d'informations, reportez-vous à la section link:https://learn.microsoft.com/en-us/windows-server/failover-clustering/failover-cluster-csvs#add-a-disk-to-csv-on-a-failover-cluster["Utilisez les volumes partagés de cluster dans un cluster de basculement"].

*Créer des machines virtuelles hautement disponibles:*

Pour créer une machine virtuelle hautement disponible, procédez comme suit :

. Dans le Gestionnaire de clusters de basculement, sélectionnez ou spécifiez le cluster souhaité. Assurez-vous que l'arborescence de la console sous le cluster est développée.
. Cliquez sur rôles.
. Dans le volet actions, cliquez sur machines virtuelles, puis sur Nouvelle machine virtuelle. L'Assistant Nouvelle machine virtuelle s'affiche. Cliquez sur Suivant.
. Sur la page spécifier le nom et l'emplacement, spécifiez un nom pour la machine virtuelle, tel que nimdemo. Cliquez sur stocker la machine virtuelle dans un autre emplacement, puis saisissez le chemin complet ou cliquez sur Parcourir et naviguez jusqu'au stockage partagé.
. Attribuez de la mémoire et configurez la carte réseau sur le commutateur virtuel associé à la carte réseau physique.
. Sur la page connecter un disque dur virtuel, cliquez sur Créer un disque dur virtuel.
. Sur la page Options d'installation, cliquez sur installer un système d'exploitation à partir d'un CD/DVD-ROM de démarrage. Sous support, spécifiez l'emplacement du support, puis cliquez sur Terminer.
. La machine virtuelle est créée. L'Assistant haute disponibilité de Failover Cluster Manager configure ensuite automatiquement la machine virtuelle pour la haute disponibilité.


====
.Provisionnement rapide de disques virtuels à l'aide de la fonction ODX
[%collapsible]
====
La fonction ODX de ONTAP permet de copier des VHDX maîtres simplement en copiant un fichier VHDX maître hébergé par le système de stockage ONTAP. Aucune copie compatible avec ODX ne plaçant aucune donnée sur le réseau, le processus de copie s'effectue côté stockage NetApp et peut donc être six à huit fois plus rapide. Les considérations générales relatives au provisionnement rapide incluent les images syspreppées originales stockées sur des partages de fichiers et les processus de copie réguliers lancés par les machines hôtes Hyper-V.


NOTE: ONTAP prend en charge ODX à la fois pour les protocoles SMB et SAN.


NOTE: Pour bénéficier des utilisations de l'intercommunication de déchargement des copies ODX avec Hyper-V, le système d'exploitation invité doit prendre en charge ODX, et les disques du système d'exploitation invité doivent être des disques SCSI pris en charge par un système de stockage (SMB ou SAN) prenant en charge ODX. Les disques IDE du système d'exploitation invité ne prennent pas en charge le pass-through ODX.

====
.Optimisation des performances
[%collapsible]
====
Bien que le nombre recommandé de machines virtuelles par CSV soit subjectif, de nombreux facteurs déterminent le nombre optimal de machines virtuelles pouvant être placées sur chaque volume CSV ou SMB. Bien que la plupart des administrateurs ne tiennent compte de la capacité que, le nombre d'E/S simultanées envoyées au VHDx est l'un des facteurs les plus importants pour les performances globales. Le moyen le plus simple de contrôler les performances consiste à réguler le nombre de machines virtuelles placées sur chaque fichier CSV ou partage. Si les modèles d'E/S simultanés de la machine virtuelle envoient trop de trafic vers le fichier CSV ou le partage, les files d'attente de disques se remplissent et une latence plus élevée est générée.

====
.Dimensionnement de volume SMB et CSV
[%collapsible]
====
S'assurer que la solution est correctement dimensionnée de bout en bout pour éviter les goulets d'étranglement et lorsqu'un volume est créé à des fins de stockage des machines virtuelles Hyper-V, la meilleure pratique consiste à créer un volume ne dépassant pas les besoins. Un dimensionnement adéquat des volumes empêche de placer accidentellement un trop grand nombre de machines virtuelles sur le CSV et réduit le risque de conflit de ressources. Chaque volume partagé de cluster (CSV) prend en charge une ou plusieurs machines virtuelles. Le nombre de machines virtuelles à placer dans un fichier CSV dépend de la charge de travail et des préférences de l'entreprise, ainsi que de l'utilisation des fonctionnalités de stockage ONTAP telles que les snapshots et la réplication. Le placement de plusieurs machines virtuelles dans un fichier CSV est un bon point de départ dans la plupart des scénarios de déploiement. Adaptez cette approche pour des cas d'utilisation spécifiques afin de répondre aux exigences de performance et de protection des données.

Comme les volumes et les VHDx peuvent facilement être augmentés, si une machine virtuelle a besoin de capacités supplémentaires, il n'est pas nécessaire de dimensionner les CSV plus grands que nécessaire. Diskpart peut être utilisé pour étendre la taille CSV. Une approche plus simple consiste à créer un nouveau CSV et à migrer les VM requises vers le nouveau CSV. Pour obtenir des performances optimales, la meilleure pratique consiste à augmenter le nombre de CSV plutôt que leur taille en tant que mesure intermédiaire.

====
.Migration
[%collapsible]
====
Dans le contexte actuel du marché, la migration est l'un des cas d'utilisation les plus courants. Les clients peuvent utiliser VMM Fabric ou d'autres outils de migration tiers pour migrer des machines virtuelles. Ces outils utilisent la copie au niveau de l'hôte pour déplacer les données de la plateforme source vers la plateforme de destination, ce qui peut prendre du temps en fonction du nombre de machines virtuelles en cours de migration.

L'utilisation de ONTAP dans de tels scénarios permet une migration plus rapide que l'utilisation d'un processus de migration basé sur hôte. ONTAP permet également la migration rapide des machines virtuelles d'un hyperviseur à un autre (dans ce cas, ESXi vers Hyper-V). Un VMDK de toute taille peut être converti en VHDx en quelques secondes sur un système de stockage NetApp. C'est notre méthode PowerShell qui s'appuie sur la technologie NetApp FlexClone® pour la conversion rapide de disques durs de machines virtuelles. Il gère également la création et la configuration des VM cibles et de destination.

Ce processus contribue à réduire les temps d'indisponibilité et à améliorer la productivité de l'entreprise. Elle offre également choix et flexibilité en réduisant les coûts de licence, la dépendance et les engagements envers un seul fournisseur. Cette fonctionnalité est également avantageuse pour les entreprises qui cherchent à optimiser les coûts de licence des machines virtuelles et à étendre leurs budgets INFORMATIQUES.

Pour plus d'informations sur la migration à l'aide de FlexClone et de PowerShell, reportez-vous à la section link:#appendix["Annexe A"].

====


=== La protection des données

.Restauration à l'aide du snapshot de stockage NetApp
[%collapsible]
====
La sauvegarde des machines virtuelles et leur restauration ou clonage rapides font partie des atouts majeurs des volumes ONTAP. Utilisez les copies Snapshot pour réaliser des copies FlexClone rapides des machines virtuelles, voire de l'ensemble du volume CSV, sans affecter les performances. Cela permet d'utiliser les données de production sans risque de corruption des données lors du clonage des volumes de données de production et de leur montage dans des environnements de QA, de test et de développement. Les volumes FlexClone sont utiles pour réaliser des copies de test des données de production, sans avoir à doubler l'espace requis pour copier les données.

Gardez à l'esprit que les nœuds Hyper-V attribuent à chaque disque un ID unique et la prise d'un instantané du volume qui a la partition respective (MBR ou GPT) portera la même identification unique. MBR utilise des signatures de disque et GPT utilise des GUID (Global unique identifier). Dans le cas d'un hôte Hyper-V autonome, le volume FlexClone peut être facilement monté sans conflits. En effet, les serveurs Hyper-V autonomes peuvent détecter automatiquement les ID de disque dupliqués et les modifier de façon dynamique sans intervention de l'utilisateur. Cette approche peut être utilisée pour restaurer la ou les machines virtuelles en copiant les disques durs virtuels selon les exigences du scénario.

Bien que cela soit simple avec les hôtes Hyper-V autonomes, la procédure est différente pour les clusters Hyper-V. Le processus de restauration implique le mappage du volume FlexClone sur un hôte Hyper-V autonome ou l'utilisation d'une pièce de disque pour modifier manuellement la signature en mappant le volume FlexClone sur un hôte Hyper-V autonome (c'est important, car un conflit d'ID de disque empêche de mettre le disque en ligne). mappez le volume FlexClone sur le cluster.

====
.Sauvegarde et restauration à l'aide d'une solution tierce
[%collapsible]
====

NOTE: Cette section utilise CommVault, mais cela s'applique à d'autres solutions tierces.

À l'aide des snapshots ONTAP, CommVault IntelliSnap® crée des snapshots matériels
D'Hyper-V. Les sauvegardes peuvent être automatisées en fonction de la configuration d'un hyperviseur Hyper-V ou d'un groupe de machines virtuelles, ou manuellement pour un groupe de machines virtuelles ou un serveur virtuel spécifique. IntelliSnap assure une protection rapide des environnements Hyper-V sans charge minimale sur la batterie de virtualisation de production. L'intégration de la technologie IntelliSnap à l'agent VSA (Virtual Server Agent) permet à la baie NetApp ONTAP de réaliser des sauvegardes avec un grand nombre de machines virtuelles et de datastores en quelques minutes. L'accès granulaire permet la restauration de fichiers et de dossiers individuels à partir du niveau de stockage secondaire, ainsi que des fichiers .vhd invités complets.

Avant de configurer l'environnement de virtualisation, déployez les agents appropriés nécessitant l'intégration de snapshots à la baie. Les environnements de virtualisation Microsoft Hyper-V requièrent les agents suivants :

* MediaAgent
* VSA (Virtual Server Agent)
* VSS Hardware Provider (Windows Server 2012 et les systèmes d'exploitation plus récents)


*Configurer la baie NetApp à l'aide de la gestion de baie*

Les étapes suivantes montrent comment configurer les sauvegardes de machine virtuelle IntelliSnap dans un environnement utilisant une baie ONTAP et Hyper-V.

. Dans le ruban de la console CommCell, cliquez sur l'onglet Storage (stockage), puis sur Array Management (gestion de la matrice).
. La boîte de dialogue gestion des matrices s'affiche.
. Cliquez sur Ajouter.
+
La boîte de dialogue Propriétés de la matrice s'affiche.

+
image:hyperv-deploy-image09.png["Illustration de la boîte de dialogue Propriétés de la matrice"]

. Dans l'onglet général, spécifiez les informations suivantes :
. Dans la liste fournisseur d'aimantation, sélectionnez NetApp.
. Dans la zone Nom, entrez le nom d'hôte, le nom de domaine complet (FQDN) ou l'adresse TCP/IP du serveur de fichiers principal.
. Dans l'onglet nœuds d'accès de la matrice, sélectionnez agents de support disponibles.
. Dans l'onglet Configuration de l'aimantation, configurez les propriétés de configuration de l'instantané en fonction de vos besoins.
. Cliquez sur OK.
. <Mandatory step> une fois configuré, configurer également le SVM sur la baie de stockage NetApp en utilisant l'option Detect pour détecter automatiquement les machines virtuelles de stockage (SVM), puis choisir un SVM. Avec l'option Add, ajouter le SVM dans la base de données CommServe comme entrée de gestion de baie.
+
image:hyperv-deploy-image10.png["Image Configuration du SVM en tant qu'entrée de gestion de baie"]

. Cliquez sur Avancé (comme illustré dans les graphiques ci-dessous) et cochez la case Activer IntelliSnap.
+
image:hyperv-deploy-image11.png["Image affichant l'option Activer IntelliSnap"]



Pour obtenir des instructions détaillées sur la configuration de la matrice, reportez-vous à la section link:https://documentation.commvault.com/11.20/configuring_netapp_array_using_array_management.html["Configuration de la matrice NetApp"] et link:https://cvdocssaproduction.blob.core.windows.net/cvdocsproduction/2023e/expert/configuring_storage_virtual_machines_on_netapp_arrays.html["Configuration des machines virtuelles de stockage sur des baies NetApp"]

*Ajouter Hyper-V en tant qu'hyperviseur*

L'étape suivante consiste à ajouter un hyperviseur Hyper-V et un groupe de machines virtuelles.

Conditions préalables :

* L'hyperviseur peut être un cluster Hyper-V, un serveur Hyper-V dans un cluster ou un serveur Hyper-V autonome.
* L'utilisateur doit appartenir au groupe d'administrateurs Hyper-V pour Hyper-V Server 2012 et versions ultérieures. Dans le cas d'un cluster Hyper-V, le compte d'utilisateur doit disposer d'autorisations complètes sur le cluster (lecture et contrôle total).
* Identifiez un ou plusieurs nœuds sur lesquels vous allez installer l'agent VSA (Virtual Server Agent) pour créer des nœuds d'accès (proxys VSA) pour les opérations de sauvegarde et de restauration. Pour découvrir les serveurs Hyper-V, le VSA doit être installé sur le système CommServe.
* Pour utiliser le suivi des blocs modifiés pour Hyper-V 2012 R2, sélectionnez tous les nœuds du cluster Hyper-V.


Les étapes suivantes montrent comment ajouter Hyper-V en tant qu'hyperviseur.

. Une fois la configuration du noyau terminée, dans l'onglet protection, cliquez sur la mosaïque virtualisation.
. Sur la page Créer un plan de sauvegarde du serveur, saisissez un nom pour le plan, puis fournissez des informations sur le stockage, la conservation et les planifications de sauvegarde.
. La page Ajouter un hyperviseur s'affiche alors > Sélectionner un fournisseur : sélectionnez Hyper-V (saisissez l'adresse IP ou le nom de domaine complet et les informations d'identification de l'utilisateur)
. Pour un serveur Hyper-V, cliquez sur détecter les nœuds. Lorsque le champ nœuds est renseigné, sélectionnez un ou plusieurs nœuds sur lesquels installer Virtual Server Agent.
+
image:hyperv-deploy-image12.png["Image affichant la détection des nœuds hyper-v"]

. Cliquez sur Suivant et sur Enregistrer.
+
image:hyperv-deploy-image13.png["Image montrant les résultats de l'étape précédente"]

. Sur la page Ajouter un groupe de machines virtuelles, sélectionnez les machines virtuelles à protéger (Demogrp est le groupe de machines virtuelles créé dans ce cas) et activez l'option IntelliSnap, comme illustré ci-dessous.
+
image:hyperv-deploy-image14.png["Image montrant la sélection de machines virtuelles à protéger"]

+

NOTE: Lorsque IntelliSnap est activé sur un groupe de VM, CommVault crée automatiquement des règles de planification pour les copies principales (Snap) et de sauvegarde.

. Cliquez sur Enregistrer.


Pour obtenir des instructions détaillées sur la configuration de la matrice, reportez-vous à la section link:https://documentation.commvault.com/2023e/essential/guided_setup_for_hyper_v.html["Ajout d'un hyperviseur"].

*Exécution d'une sauvegarde:*

. Dans le volet de navigation, accédez à protection > virtualisation. La page machines virtuelles s'affiche.
. Sauvegarder la machine virtuelle ou le groupe de machines virtuelles. Dans cette démo, le groupe VM est sélectionné. Dans la ligne du groupe VM, cliquez sur le bouton action_button, puis sélectionnez Sauvegarder. Dans ce cas, nimplaan est le plan associé à Demogrp et Demogrp01.
+
image:hyperv-deploy-image15.png["Image montrant la boîte de dialogue de sélection des machines virtuelles à sauvegarder"]

. Une fois la sauvegarde réussie, les points de restauration sont disponibles comme indiqué dans la capture d'écran. À partir de la copie Snapshot, il est possible d'effectuer la restauration de la machine virtuelle complète et la restauration des fichiers et dossiers invités.
+
image:hyperv-deploy-image16.png["Image affichant les points de restauration d'une sauvegarde"]

+

NOTE: Pour les machines virtuelles critiques et fortement utilisées, le nombre de machines virtuelles par CSV doit être réduit



*Exécution d'une opération de restauration :*

Restaurez des machines virtuelles complètes, des fichiers et dossiers invités ou des fichiers de disque virtuel via les points de restauration.

. Dans le volet de navigation, accédez à protection > virtualisation ; la page machines virtuelles s'affiche.
. Cliquez sur l'onglet VM Groups.
. La page VM group s'affiche.
. Dans la zone VM Groups, cliquez sur Restore pour le groupe VM contenant la machine virtuelle.
. La page Sélectionner le type de restauration s'affiche.
+
image:hyperv-deploy-image17.png["Image montrant les types de restauration d'une sauvegarde"]

. Sélectionnez fichiers invités ou machine virtuelle complète en fonction de la sélection et déclenchez la restauration.
+
image:hyperv-deploy-image18.png["Image affichant les options de restauration"]



Pour obtenir des instructions détaillées sur toutes les options de restauration prises en charge, reportez-vous à la section link:https://documentation.commvault.com/2023e/essential/restores_for_hyper_v.html["Restaurations pour Hyper-V."].

====


=== Options NetApp ONTAP avancées

NetApp SnapMirror assure une réplication efficace du stockage site à site, assurant ainsi la reprise d'activité
restauration rapide, fiable et gérable pour s'adapter aux besoins des entreprises modernes du monde entier. En répliquant des données à grande vitesse sur des réseaux LAN et WAN, SnapMirror assure une haute disponibilité des données et une restauration rapide pour les applications stratégiques, ainsi que des fonctionnalités exceptionnelles de déduplication du stockage et de compression réseau. Avec la technologie NetApp SnapMirror, la reprise d'activité protège l'ensemble du data Center. Les volumes peuvent effectuer des sauvegardes incrémentielles vers un emplacement hors site. SnapMirror effectue une réplication incrémentielle basée sur les blocs aussi souvent que le RPO requis. Les mises à jour au niveau des blocs réduisent les besoins en bande passante et en temps, et la cohérence des données est préservée sur le site de reprise après incident.

Une étape importante consiste à créer un transfert unique de base de données pour l'ensemble du dataset. Cette opération est nécessaire avant que les mises à jour incrémentielles ne puissent être effectuées. Cette opération comprend la création d'une copie Snapshot à la source et le transfert de tous les blocs de données référencés par celle-ci vers le système de fichiers de destination. Une fois l'initialisation terminée, des mises à jour planifiées ou déclenchées manuellement peuvent se produire. Chaque mise à jour transfère uniquement les nouveaux blocs et les blocs modifiés de la source vers le système de fichiers de destination. Cette opération permet notamment de créer une copie Snapshot au niveau du volume source, de la comparer à la copie de base et de transférer uniquement les blocs modifiés vers le volume de destination. La nouvelle copie devient la copie de base pour la mise à jour suivante. Comme la réplication est périodique, SnapMirror peut consolider les blocs modifiés et économiser la bande passante réseau. L'impact sur le débit d'écriture et la latence d'écriture est minimal.

La récupération s'effectue en suivant les étapes suivantes :

. Connectez-vous au système de stockage sur le site secondaire.
. Interrompre la relation SnapMirror
. Mappez les LUN du volume SnapMirror sur le groupe initiateur (igroup) des serveurs Hyper-V sur le site secondaire.
. Une fois les LUN mappées sur le cluster Hyper-V, mettez ces disques en ligne.
. À l'aide des applets de commande PowerShell cluster-basculement, ajoutez les disques au stockage disponible et convertissez-les en CSV.
. Importez les machines virtuelles dans le CSV dans le gestionnaire Hyper-V, rendez-les hautement disponibles, puis ajoutez-les au cluster.
. Activez les machines virtuelles.




== Conclusion

ONTAP est la base de stockage partagé optimale pour déployer de nombreuses charges de travail IT. Les plateformes ONTAP AFF ou ASA sont à la fois flexibles et évolutives pour de nombreuses utilisations et applications. Windows Server 2022 et Hyper-V sont souvent utilisés comme solution de virtualisation, décrite dans ce document. La flexibilité et l'évolutivité du stockage ONTAP et des fonctionnalités associées permettent aux clients de démarrer avec une couche de stockage correctement dimensionnée, capable d'évoluer et de s'adapter à leurs besoins. Dans les conditions actuelles du marché, Hyper-V propose une alternative idéale à l'hyperviseur, qui offre la plupart des fonctionnalités fournies par VMware.



== Annexe A : migration à l'aide de FlexClone et de PowerShell

.Script PowerShell
[%collapsible]
====
[source, powershell]
----
param (
    [Parameter(Mandatory=$True, HelpMessage="VCenter DNS name or IP Address")]
    [String]$VCENTER,
    [Parameter(Mandatory=$True, HelpMessage="NetApp ONTAP NFS Datastore name")]
    [String]$DATASTORE,
    [Parameter(Mandatory=$True, HelpMessage="VCenter credentials")]
    [System.Management.Automation.PSCredential]$VCENTER_CREDS,
    [Parameter(Mandatory=$True, HelpMessage="The IP Address of the ONTAP Cluster")]
    [String]$ONTAP_CLUSTER,
    [Parameter(Mandatory=$True, HelpMessage="NetApp ONTAP VServer/SVM name")]
    [String]$VSERVER,
    [Parameter(Mandatory=$True, HelpMessage="NetApp ONTAP NSF,SMB Volume name")]
    [String]$ONTAP_VOLUME_NAME,
    [Parameter(Mandatory=$True, HelpMessage="ONTAP NFS/CIFS Volume mount Drive on Hyper-V host")]
    [String]$ONTAP_NETWORK_SHARE_ADDRESS,
    [Parameter(Mandatory=$True, HelpMessage="NetApp ONTAP Volume QTree folder name")]
    [String]$VHDX_QTREE_NAME,
    [Parameter(Mandatory=$True, HelpMessage="The Credential to connect to the ONTAP Cluster")]
    [System.Management.Automation.PSCredential]$ONTAP_CREDS,
    [Parameter(Mandatory=$True, HelpMessage="Hyper-V VM switch name")]
    [String]$HYPERV_VM_SWITCH
)

function main {

    ConnectVCenter

    ConnectONTAP

    GetVMList

    GetVMInfo

    #PowerOffVMs

    CreateOntapVolumeSnapshot

    Shift

    ConfigureVMsOnHyperV
}

function ConnectVCenter {
    Write-Host "------------------------------------------------------------------------------" -ForegroundColor Cyan
    Write-Host "Connecting to vCenter $VCENTER" -ForegroundColor Magenta
    Write-Host "------------------------------------------------------------------------------`n" -ForegroundColor Cyan

    [string]$vmwareModuleName = "VMware.VimAutomation.Core"

    Write-Host "Importing VMware $vmwareModuleName Powershell module"
    if ((Get-Module|Select-Object -ExpandProperty Name) -notcontains $vmwareModuleName) {
        Try {
            Import-Module $vmwareModuleName -ErrorAction Stop
            Write-Host "$vmwareModuleName imported successfully" -ForegroundColor Green
        } Catch {
            Write-Error "Error: $vmwareMdouleName PowerShell module not found"
			break;
        }
    }
    else {
        Write-Host "$vmwareModuleName Powershell module already imported" -ForegroundColor Green
    }

    Write-Host "`nConnecting to vCenter $VCENTER"
    Try {
        $connect = Connect-VIServer -Server $VCENTER -Protocol https -Credential $VCENTER_CREDS -ErrorAction Stop
        Write-Host "Connected to vCenter $VCENTER" -ForegroundColor Green
    } Catch {
        Write-Error "Failed to connect to vCenter $VCENTER. Error : $($_.Exception.Message)"
		break;
    }
}

function ConnectONTAP {
    Write-Host "`n------------------------------------------------------------------------------" -ForegroundColor Cyan
    Write-Host "Connecting to VSerevr $VSERVER at ONTAP Cluster $ONTAP_CLUSTER" -ForegroundColor Magenta
    Write-Host "------------------------------------------------------------------------------`n" -ForegroundColor Cyan

    [string]$ontapModuleName = "NetApp.ONTAP"

    Write-Host "Importing NetApp ONTAP $ontapModuleName Powershell module"
    if ((Get-Module|Select-Object -ExpandProperty Name) -notcontains $ontapModuleName) {
        Try {
            Import-Module $ontapModuleName -ErrorAction Stop
            Write-Host "$ontapModuleName imported successfully" -ForegroundColor Green
        } Catch {
            Write-Error "Error: $vmwareMdouleName PowerShell module not found"
			break;
        }
    }
    else {
        Write-Host "$ontapModuleName Powershell module already imported" -ForegroundColor Green
    }

    Write-Host "`nConnecting to ONTAP Cluster $ONTAP_CLUSTER"
    Try {
        $connect = Connect-NcController -Name $ONTAP_CLUSTER -Credential $ONTAP_CREDS -Vserver $VSERVER
        Write-Host "Connected to ONTAP Cluster $ONTAP_CLUSTER" -ForegroundColor Green
    } Catch {
        Write-Error "Failed to connect to ONTAP Cluster $ONTAP_CLUSTER. Error : $($_.Exception.Message)"
		break;
    }
}

function GetVMList {
    Write-Host "`n------------------------------------------------------------------------------" -ForegroundColor Cyan
    Write-Host "Fetching powered on VMs list with Datastore $DATASTORE" -ForegroundColor Magenta
    Write-Host "------------------------------------------------------------------------------`n" -ForegroundColor Cyan
    try {
        $vmList = VMware.VimAutomation.Core\Get-VM -Datastore $DATASTORE -ErrorAction Stop| Where-Object {$_.PowerState -eq "PoweredOn"} | OUT-GridView -OutputMode Multiple
        #$vmList = Get-VM -Datastore $DATASTORE -ErrorAction Stop| Where-Object {$_.PowerState -eq "PoweredOn"}

        if($vmList) {
            Write-Host "Selected VMs for Shift" -ForegroundColor Green
            $vmList | Format-Table -Property Name
            $Script:VMList = $vmList
        }
        else {
            Throw "No VMs selected"
        }
    }
    catch {
        Write-Error "Failed to get VM List. Error : $($_.Exception.Message)"
        Break;
    }
}

function GetVMInfo {
    Write-Host "------------------------------------------------------------------------------" -ForegroundColor Cyan
    Write-Host "VM Information" -ForegroundColor Magenta
    Write-Host "------------------------------------------------------------------------------" -ForegroundColor Cyan
    $vmObjArray = New-Object System.Collections.ArrayList

    if($VMList) {
        foreach($vm in $VMList) {
            $vmObj = New-Object -TypeName System.Object

            $vmObj | Add-Member -MemberType NoteProperty -Name ID -Value $vm.Id
            $vmObj | Add-Member -MemberType NoteProperty -Name Name -Value $vm.Name
            $vmObj | Add-Member -MemberType NoteProperty -Name NumCpu -Value $vm.NumCpu
            $vmObj | Add-Member -MemberType NoteProperty -Name MemoryGB -Value $vm.MemoryGB
            $vmObj | Add-Member -MemberType NoteProperty -Name Firmware -Value $vm.ExtensionData.Config.Firmware

            $vmDiskInfo = $vm | VMware.VimAutomation.Core\Get-HardDisk

            $vmDiskArray = New-Object System.Collections.ArrayList
            foreach($disk in $vmDiskInfo) {
                $diskObj = New-Object -TypeName System.Object

                $diskObj | Add-Member -MemberType NoteProperty -Name Name -Value $disk.Name

                $fileName = $disk.Filename
                if ($fileName -match '\[(.*?)\]') {
                    $dataStoreName = $Matches[1]
                }

                $parts = $fileName -split " "
                $pathParts = $parts[1] -split "/"
                $folderName = $pathParts[0]
                $fileName = $pathParts[1]

                $diskObj | Add-Member -MemberType NoteProperty -Name DataStore -Value $dataStoreName
                $diskObj | Add-Member -MemberType NoteProperty -Name Folder -Value $folderName
                $diskObj | Add-Member -MemberType NoteProperty -Name Filename -Value $fileName
                $diskObj | Add-Member -MemberType NoteProperty -Name CapacityGB -Value $disk.CapacityGB

                $null = $vmDiskArray.Add($diskObj)
            }

            $vmObj | Add-Member -MemberType NoteProperty -Name PrimaryHardDisk -Value "[$($vmDiskArray[0].DataStore)] $($vmDiskArray[0].Folder)/$($vmDiskArray[0].Filename)"
            $vmObj | Add-Member -MemberType NoteProperty -Name HardDisks -Value $vmDiskArray

            $null = $vmObjArray.Add($vmObj)

            $vmNetworkArray = New-Object System.Collections.ArrayList

            $vm |
            ForEach-Object {
              $VM = $_
              $VM | VMware.VimAutomation.Core\Get-VMGuest | Select-Object -ExpandProperty Nics |
              ForEach-Object {
                $Nic = $_
                foreach ($IP in $Nic.IPAddress)
                {
                  if ($IP.Contains('.'))
                  {
                    $networkObj = New-Object -TypeName System.Object

                    $vlanId = VMware.VimAutomation.Core\Get-VirtualPortGroup | Where-Object {$_.Key -eq $Nic.NetworkName}
                    $networkObj | Add-Member -MemberType NoteProperty -Name VLanID -Value $vlanId
                    $networkObj | Add-Member -MemberType NoteProperty -Name IPv4Address -Value $IP

                    $null = $vmNetworkArray.Add($networkObj)
                  }
                }
              }
            }

            $vmObj | Add-Member -MemberType NoteProperty -Name PrimaryIPv4 -Value $vmNetworkArray[0].IPv4Address
            $vmObj | Add-Member -MemberType NoteProperty -Name PrimaryVLanID -Value $vmNetworkArray.VLanID
            $vmObj | Add-Member -MemberType NoteProperty -Name Networks -Value $vmNetworkArray

            $guest = $vm.Guest
            $parts = $guest -split ":"
            $afterColon = $parts[1]

            $osFullName = $afterColon

            $vmObj | Add-Member -MemberType NoteProperty -Name OSFullName -Value $osFullName
            $vmObj | Add-Member -MemberType NoteProperty -Name GuestID -Value $vm.GuestId
        }
    }

    $vmObjArray | Format-Table -Property ID, Name, NumCpu, MemoryGB, PrimaryHardDisk, PrimaryIPv4, PrimaryVLanID, GuestID, OSFullName, Firmware

    $Script:VMObjList = $vmObjArray
}

function PowerOffVMs {
    Write-Host "`n------------------------------------------------------------------------------" -ForegroundColor Cyan
    Write-Host "Power Off VMs" -ForegroundColor Magenta
    Write-Host "------------------------------------------------------------------------------`n" -ForegroundColor Cyan
    foreach($vm in $VMObjList) {
        try {
            Write-Host "Powering Off VM $($vm.Name) in vCenter $($VCENTER)"
            $null = VMware.VimAutomation.Core\Stop-VM -VM $vm.Name -Confirm:$false -ErrorAction Stop
            Write-Host "Powered Off VM $($vm.Name)" -ForegroundColor Green
        }
        catch {
            Write-Error "Failed to Power Off VM $($vm.Name). Error : $._Exception.Message"
            Break;
        }
        Write-Host "`n"
    }
}

function CreateOntapVolumeSnapshot {
    Write-Host "`n------------------------------------------------------------------------------" -ForegroundColor Cyan
    Write-Host "Taking ONTAP Snapshot for Volume $ONTAP_VOLUME_NAME" -ForegroundColor Magenta
    Write-Host "------------------------------------------------------------------------------`n" -ForegroundColor Cyan

    Try {
        Write-Host "Taking snapshot for Volume $ONTAP_VOLUME_NAME"
        $timestamp = Get-Date -Format "yyyy-MM-dd_HHmmss"
        $snapshot = New-NcSnapshot -VserverContext $VSERVER -Volume $ONTAP_VOLUME_NAME -Snapshot "snap.script-$timestamp"

        if($snapshot) {
            Write-Host "Snapshot ""$($snapshot.Name)"" created for Volume $ONTAP_VOLUME_NAME" -ForegroundColor Green
            $Script:OntapVolumeSnapshot = $snapshot
        }
    } Catch {
        Write-Error "Failed to create snapshot for Volume $ONTAP_VOLUME_NAME. Error : $_.Exception.Message"
        Break;
    }
}

function Shift {
    Write-Host "------------------------------------------------------------------------------" -ForegroundColor Cyan
    Write-Host "VM Shift" -ForegroundColor Magenta
    Write-Host "------------------------------------------------------------------------------`n" -ForegroundColor Cyan

    $Script:HypervVMList = New-Object System.Collections.ArrayList
    foreach($vmObj in $VMObjList) {

        Write-Host "***********************************************"
        Write-Host "Performing VM conversion for $($vmObj.Name)" -ForegroundColor Blue
        Write-Host "***********************************************"

        $hypervVMObj = New-Object -TypeName System.Object

        $directoryName = "/vol/$($ONTAP_VOLUME_NAME)/$($VHDX_QTREE_NAME)/$($vmObj.HardDisks[0].Folder)"

        try {
            Write-Host "Creating Folder ""$directoryName"" for VM $($vmObj.Name)"
            $dir = New-NcDirectory -VserverContext $VSERVER -Path $directoryName -Permission 0777 -Type directory -ErrorAction Stop
            if($dir) {
                Write-Host "Created folder ""$directoryName"" for VM $($vmObj.Name)`n" -ForegroundColor Green
            }
        }
        catch {
            if($_.Exception.Message -eq "[500]: File exists") {
                Write-Warning "Folder ""$directoryName"" already exists!`n"
            }
            Else {
                Write-Error "Failed to create folder ""$directoryName"" for VM $($vmObj.Name). Error : $($_.Exception.Message)"
                Break;
            }
        }

        $vmDiskArray = New-Object System.Collections.ArrayList

        foreach($disk in $vmObj.HardDisks) {
            $vmDiskObj = New-Object -TypeName System.Object
            try {
                Write-Host "`nConverting $($disk.Name)"
                Write-Host "--------------------------------"

                $vmdkPath = "/vol/$($ONTAP_VOLUME_NAME)/$($disk.Folder)/$($disk.Filename)"
                $fileName = $disk.Filename -replace '\.vmdk$', ''
                $vhdxPath = "$($directoryName)/$($fileName).vhdx"

                Write-Host "Converting ""$($disk.Name)"" VMDK path ""$($vmdkPath)"" to VHDX at Path ""$($vhdxPath)"" for VM $($vmObj.Name)"
                $convert = ConvertTo-NcVhdx -SourceVmdk $vmdkPath -DestinationVhdx $vhdxPath  -SnapshotName $OntapVolumeSnapshot -ErrorAction Stop -WarningAction SilentlyContinue
                if($convert) {
                    Write-Host "Successfully converted VM ""$($vmObj.Name)"" VMDK path ""$($vmdkPath)"" to VHDX at Path ""$($vhdxPath)""" -ForegroundColor Green

                    $vmDiskObj | Add-Member -MemberType NoteProperty -Name Name -Value $disk.Name
                    $vmDiskObj | Add-Member -MemberType NoteProperty -Name VHDXPath -Value $vhdxPath

                    $null = $vmDiskArray.Add($vmDiskObj)
                }
            }
            catch {
                Write-Error "Failed to convert ""$($disk.Name)"" VMDK to VHDX for VM $($vmObj.Name). Error : $($_.Exception.Message)"
                Break;
            }
        }

        $hypervVMObj | Add-Member -MemberType NoteProperty -Name Name -Value $vmObj.Name
        $hypervVMObj | Add-Member -MemberType NoteProperty -Name HardDisks -Value $vmDiskArray
        $hypervVMObj | Add-Member -MemberType NoteProperty -Name MemoryGB -Value $vmObj.MemoryGB
        $hypervVMObj | Add-Member -MemberType NoteProperty -Name Firmware -Value $vmObj.Firmware
        $hypervVMObj | Add-Member -MemberType NoteProperty -Name GuestID -Value $vmObj.GuestID



        $null = $HypervVMList.Add($hypervVMObj)
        Write-Host "`n"

    }
}

function ConfigureVMsOnHyperV {
    Write-Host "------------------------------------------------------------------------------" -ForegroundColor Cyan
    Write-Host "Configuring VMs on Hyper-V" -ForegroundColor Magenta
    Write-Host "------------------------------------------------------------------------------`n" -ForegroundColor Cyan

    foreach($vm in $HypervVMList) {
        try {

            # Define the original path
            $originalPath = $vm.HardDisks[0].VHDXPath
            # Replace forward slashes with backslashes
            $windowsPath = $originalPath -replace "/", "\"

            # Replace the initial part of the path with the Windows drive letter
            $windowsPath = $windowsPath -replace "^\\vol\\", "\\$($ONTAP_NETWORK_SHARE_ADDRESS)\"

            $vmGeneration = if ($vm.Firmware -eq "bios") {1} else {2};

            Write-Host "***********************************************"
            Write-Host "Creating VM $($vm.Name)" -ForegroundColor Blue
            Write-Host "***********************************************"
            Write-Host "Creating VM $($vm.Name) with Memory $($vm.MemoryGB)GB, vSwitch $($HYPERV_VM_SWITCH), $($vm.HardDisks[0].Name) ""$($windowsPath)"", Generation $($vmGeneration) on Hyper-V"

            $createVM = Hyper-V\New-VM -Name $vm.Name -VHDPath $windowsPath -SwitchName $HYPERV_VM_SWITCH -MemoryStartupBytes (Invoke-Expression "$($vm.MemoryGB)GB") -Generation $vmGeneration -ErrorAction Stop
            if($createVM) {
                Write-Host "VM $($createVM.Name) created on Hyper-V host`n" -ForegroundColor Green


                $index = 0
                foreach($vmDisk in $vm.HardDisks) {
                    $index++
                    if ($index -eq 1) {
                        continue
                    }

                    Write-Host "`nAttaching $($vmDisk.Name) for VM $($vm.Name)"
                    Write-Host "---------------------------------------------"

                    $originalPath = $vmDisk.VHDXPath

                    # Replace forward slashes with backslashes
                    $windowsPath = $originalPath -replace "/", "\"

                    # Replace the initial part of the path with the Windows drive letter
                    $windowsPath = $windowsPath -replace "^\\vol\\", "\\$($ONTAP_NETWORK_SHARE_ADDRESS)\"

                    try {
                        $attachDisk = Hyper-v\Add-VMHardDiskDrive -VMName $vm.Name -Path $windowsPath -ErrorAction Stop
                        Write-Host "Attached $($vmDisk.Name) ""$($windowsPath)"" to VM $($vm.Name)" -ForegroundColor Green
                    }
                    catch {
                        Write-Error "Failed to attach $($vmDisk.Name) $($windowsPath) to VM $($vm.Name): Error : $($_.Exception.Message)"
                        Break;
                    }
                }

                if($vmGeneration -eq 2 -and $vm.GuestID -like "*rhel*") {
                    try {
                        Write-Host "`nDisabling secure boot"
                        Hyper-V\Set-VMFirmware -VMName $createVM.Name -EnableSecureBoot Off -ErrorAction Stop
                        Write-Host "Secure boot disabled" -ForegroundColor Green
                    }
                    catch {
                        Write-Error "Failed to disable secure boot for VM $($createVM.Name). Error : $($_.Exception.Message)"
                    }
                }

                try {
                    Write-Host "`nStarting VM $($createVM.Name)"
                    Hyper-v\Start-VM -Name $createVM.Name -ErrorAction Stop
                    Write-Host "Started VM $($createVM.Name)`n" -ForegroundColor Green
                }
                catch {
                    Write-Error "Failed to start VM $($createVM.Name). Error : $($_.Exception.Message)"
                    Break;
                }
            }
        }
        catch {
            Write-Error "Failed  to create VM $($vm.Name) on Hyper-V. Error : $($_.Exception.Message)"
            Break;
        }
    }
}

main
----
====