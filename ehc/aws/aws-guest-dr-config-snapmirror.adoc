---
sidebar: sidebar 
permalink: ehc/aws/aws-guest-dr-config-snapmirror.html 
keywords: Intercluster logical interfaces, cluster peering, SVM peering, snapshot retention policy, destination volumes, SnapMirror relationships 
summary: 'SnapCenter peut mettre à jour les relations SnapMirror dans le système de stockage primaire (primaire > miroir) et vers des systèmes de stockage secondaires (primaire > archivage sécurisé) pour l"archivage et la conservation à long terme. Pour ce faire, vous devez établir et initialiser une relation de réplication des données entre un volume de destination et un volume source à l"aide de SnapMirror.' 
---
= Configurez des relations SnapMirror et des planifications de conservation
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../../media/


link:aws-guest-dr-snapcenter-overview.html["Précédent : présentation - reprise après sinistre."]

SnapCenter peut mettre à jour les relations SnapMirror dans le système de stockage primaire (primaire > miroir) et vers des systèmes de stockage secondaires (primaire > archivage sécurisé) pour l'archivage et la conservation à long terme. Pour ce faire, vous devez établir et initialiser une relation de réplication des données entre un volume de destination et un volume source à l'aide de SnapMirror.

Les systèmes ONTAP source et destination doivent se trouver dans des réseaux qui sont peering via Amazon VPC, une passerelle de transit, AWS Direct Connect ou un VPN AWS.

Les étapes suivantes sont requises pour la configuration des relations SnapMirror entre un système ONTAP sur site et FSX ONTAP :

* Enregistrer les interfaces logiques intercluster source et destination
* Établir le peering de cluster entre ONTAP et FSX.
* Établir une relation de peering de SVM.
* Création d'une règle de conservation des snapshots
* Créez le volume de destination dans FSX.
* Création des relations SnapMirror entre les volumes source et de destination
* Initialiser les relations SnapMirror


Reportez-vous à la https://docs.aws.amazon.com/fsx/latest/ONTAPGuide/ONTAPGuide.pdf["FSX pour ONTAP – Guide de l'utilisateur ONTAP"^] Pour plus d'informations sur la création de relations SnapMirror avec FSX.



== Enregistrer les interfaces logiques intercluster source et destination

Pour le système ONTAP source résidant sur site, vous pouvez récupérer les informations LIF inter-cluster depuis System Manager ou depuis l'interface de ligne de commandes.

. Dans ONTAP System Manager, accédez à la page Network Overview et récupérez les adresses IP de type intercluster configurées pour communiquer avec le VPC AWS où FSX est installé.
+
image:dr-vmc-aws-image10.png["Erreur : image graphique manquante"]

. Pour récupérer les adresses IP intercluster pour FSX, connectez-vous à l'interface de ligne de commande et exécutez la commande suivante :
+
....
FSx-Dest::> network interface show -role intercluster
....
+
image:dr-vmc-aws-image11.png["Erreur : image graphique manquante"]





== Établir le peering de cluster entre ONTAP et FSX

Pour établir le peering de cluster entre clusters ONTAP, une phrase secrète unique saisie au niveau du cluster ONTAP à l'origine doit être confirmée dans l'autre cluster.

. Configurez le peering sur le cluster FSX de destination à l'aide de l' `cluster peer create` commande. Lorsque vous y êtes invité, saisissez une phrase secrète unique utilisée ultérieurement sur le cluster source pour finaliser le processus de création.
+
....
FSx-Dest::> cluster peer create -address-family ipv4 -peer-addrs source_intercluster_1, source_intercluster_2
Enter the passphrase:
Confirm the passphrase:
....
. Sur le cluster source, vous pouvez établir la relation de pairs de cluster à l'aide de ONTAP System Manager ou de l'interface de ligne de commandes. Dans ONTAP System Manager, accédez à protection > Présentation et sélectionnez Peer Cluster.
+
image:dr-vmc-aws-image12.png["Erreur : image graphique manquante"]

. Dans la boîte de dialogue Peer Cluster, saisissez les informations requises :
+
.. Saisissez la phrase de passe utilisée pour établir la relation de cluster homologue sur le cluster FSX de destination.
.. Sélectionnez `Yes` pour établir une relation chiffrée.
.. Entrer les adresses IP du LIF intercluster du cluster FSX de destination.
.. Cliquez sur initier le peering de cluster pour finaliser le processus.
+
image:dr-vmc-aws-image13.png["Erreur : image graphique manquante"]



. Vérifiez l'état de la relation cluster peer à partir du cluster FSX avec la commande suivante :
+
....
FSx-Dest::> cluster peer show
....
+
image:dr-vmc-aws-image14.png["Erreur : image graphique manquante"]





== Établir une relation de peering de SVM

L'étape suivante consiste à configurer une relation de SVM entre les machines virtuelles de stockage de destination et source qui contiennent les volumes qui seront dans les relations SnapMirror.

. Depuis le cluster FSX source, utiliser la commande suivante depuis l'interface de ligne de commande afin de créer la relation SVM peer :
+
....
FSx-Dest::> vserver peer create -vserver DestSVM -peer-vserver Backup -peer-cluster OnPremSourceSVM -applications snapmirror
....
. Depuis le cluster ONTAP source, acceptez la relation de peering avec ONTAP System Manager ou l'interface de ligne de commandes.
. Dans ONTAP System Manager, accédez à protection > Présentation et sélectionnez des VM de stockage homologues sous les pairs de machines virtuelles de stockage.
+
image:dr-vmc-aws-image15.png["Erreur : image graphique manquante"]

. Dans la boîte de dialogue de la VM de stockage homologue, remplissez les champs requis :
+
** La VM de stockage source
** Cluster destination
** L'VM de stockage de destination
+
image:dr-vmc-aws-image16.png["Erreur : image graphique manquante"]



. Cliquez sur Peer Storage VM pour terminer le processus de peering de SVM.




== Création d'une règle de conservation des snapshots

SnapCenter gère les planifications de conservation pour les sauvegardes qui existent sous forme de copies Snapshot sur le système de stockage primaire. Ceci est établi lors de la création d'une règle dans SnapCenter. SnapCenter ne gère pas de stratégies de conservation pour les sauvegardes conservées sur des systèmes de stockage secondaires. Ces règles sont gérées séparément via une règle SnapMirror créée sur le cluster FSX secondaire et associée aux volumes de destination faisant partie d'une relation SnapMirror avec le volume source.

Lors de la création d'une règle SnapCenter, vous avez la possibilité de spécifier une étiquette de règle secondaire ajoutée au label SnapMirror de chaque Snapshot généré lors de la création d'une sauvegarde SnapCenter.


NOTE: Sur le stockage secondaire, ces étiquettes sont mises en correspondance avec les règles de règle associées au volume de destination pour assurer la conservation des snapshots.

L'exemple suivant montre une étiquette SnapMirror présente sur tous les snapshots générés dans le cadre d'une règle utilisée pour les sauvegardes quotidiennes de notre base de données SQL Server et des volumes des journaux.

image:dr-vmc-aws-image17.png["Erreur : image graphique manquante"]

Pour plus d'informations sur la création de stratégies SnapCenter pour une base de données SQL Server, reportez-vous au https://docs.netapp.com/us-en/snapcenter/protect-scsql/task_create_backup_policies_for_sql_server_databases.html["Documentation SnapCenter"^].

Vous devez d'abord créer une règle SnapMirror avec des règles qui imposent le nombre de copies Snapshot à conserver.

. Création de la règle SnapMirror sur le cluster FSX
+
....
FSx-Dest::> snapmirror policy create -vserver DestSVM -policy PolicyName -type mirror-vault -restart always
....
. Ajoutez des règles à la règle avec des étiquettes SnapMirror qui correspondent aux étiquettes de règles secondaires spécifiées dans les règles de SnapCenter.
+
....
FSx-Dest::> snapmirror policy add-rule -vserver DestSVM -policy PolicyName -snapmirror-label SnapMirrorLabelName -keep #ofSnapshotsToRetain
....
+
Le script suivant fournit un exemple de règle qui peut être ajoutée à une règle :

+
....
FSx-Dest::> snapmirror policy add-rule -vserver sql_svm_dest -policy Async_SnapCenter_SQL -snapmirror-label sql-ondemand -keep 15
....
+

NOTE: Créer des règles supplémentaires pour chaque étiquette SnapMirror et le nombre de snapshots à conserver (période de conservation).





== Créer des volumes de destination

Pour créer un volume de destination sur FSX qui sera le destinataire des copies snapshot à partir de nos volumes source, exécutez la commande suivante sur FSX ONTAP :

....
FSx-Dest::> volume create -vserver DestSVM -volume DestVolName -aggregate DestAggrName -size VolSize -type DP
....


== Création des relations SnapMirror entre les volumes source et de destination

Pour créer une relation SnapMirror entre un volume source et un volume de destination, exécutez la commande suivante sur FSX ONTAP :

....
FSx-Dest::> snapmirror create -source-path OnPremSourceSVM:OnPremSourceVol -destination-path DestSVM:DestVol -type XDP -policy PolicyName
....


== Initialiser les relations SnapMirror

Initialiser la relation SnapMirror Ce processus lance un nouveau snapshot généré à partir du volume source et le copie vers le volume de destination.

Pour créer un volume, exécutez la commande suivante sur FSX ONTAP :

....
FSx-Dest::> volume create -vserver DestSVM -volume DestVolName -aggregate DestAggrName -size VolSize -type DP
....
link:aws-guest-dr-config-snapcenter.html["Suivant : déploiement et configuration de Windows SnapCenter Server sur site."]
